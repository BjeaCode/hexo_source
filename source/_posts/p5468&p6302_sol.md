---
title: P5468 & P6302 回家路线
date: 2022-01-25 21:59:04
tags:
  - DP
  - 斜率优化
categories: 题解
author: Jocker_CW
mathjax: true
---


# 回家路线 ~~加强版~~ 正常数据版
### 先怼一句啊，原题拿脚造的数据，导致一些离谱的错误能过。
### 所以称这版为正常数据版

回到正题，斜率优化好题。

给定了一张$n$个点的图，有$m$条单向边,边$i$从$u_i$到$v_i$，可以在时刻$p_i$可以进入，然后在$q_i$时刻出来。

现在有一匹牛马出现了，他想从点$1$校门口走到点$n$机房做题，他出现在点 $1$ 时是时刻$0$。

牛马不喜欢等待和走过多的路，所以每次离开一个点，都会为他增加$Ax^2+Bx+C$的愤怒值，其中$x$是他抵达在这个点等待的时长。而且牛马不喜欢太晚到机房，所以如果他在时刻$t$才进入机房，他会增加$t$的愤怒值。

牛马很傻很暴躁，当他的愤怒值过高他就会砸桌子。机房大佬$ZYWD$需要保证机房桌子的安全，所以需要为牛马规划一条会使他愤怒值尽量小的路线。

大佬$ZYWD$有着惊人的悟性，他只需要知道这个愤怒值就能逆推出路线。所以需要你给出这个愤怒值。

其中$n\leq 10^5,m\leq 10^6,0\leq A\leq 10, 0\leq B,C\leq 10^7, 0 \leq p_i<q_i\leq 4\times 10^4,u_i\not= v_i,1\leq u_i,v_i\leq n$，同时由于学校设计的很好，一定会存在可以让牛马从校门口进入机房的方案。

### ~~小葵花……~~ 开始解题
遇事不决我们先对边进行时间排序，防止出现时间倒流。

然后我们通过观察发现 **~~显然~~** 可以$DP$！

我们定义$dp[i]$是在通过边$i$后最小的愤怒值。

$DP$方程？我们知道一条边的起始节点，那么我们一定是要从终点是这个起始节点得边推过来，我们令集合$S_i^{P}$表示到达时间小于等于$P$，终点是$i$的边的集合，那么我们就有：

$$
dp[i]=\min\limits_{j\in S_{u_i}^{p_i}}(dp[j]+A*(p_i-q_j)^2+B*(p_i-q_j)+C)
$$

我们设
$$k=\arg \min\limits_{j\in S_{u_i}^{p_i}}(dp[j]+A*(p_i-q_j)^2+B*(p_i-q_j)+C)$$

则
$$dp[ i]=dp[k]+A*(p_i-q_k)^2+B*(p_i-q_k)+C$$

拆一下。

$$dp[i]=dp[k]+Ap_i^2+Aq_k^2-Ap_iq_k+Bp_i-Bq_k+C$$

$$dp[i]-Ap_i^2-Bp_i-C=dp[k]+Aq_k^2-Bq_k-Ap_iq_k$$
 发现可以拆成只与$i$有关，只与$k$有关，和只有前两者的乘积若干部分和常数。

发现可以斜率优化。

令
$$
\begin{cases}
B_i=dp[i]-Ap_i^2-Bp_i-C\\
Y_i=dp[i]+Aq_i^2-Bq_i\\
X_i=q_i\\
K_i=Ap_i\\
\end{cases}
$$

于是可以$O(1)$转移。

现在考虑如何维护$j\in S_{u_i}^{p_i}$的条件。

我们把每条边按照起始时间排序。

转移完的边以$q_i$作为关键字，扔进小根堆中（当然也可以桶排，~~但是我懒~~）。每一次转移一条边之前把堆中所有$q_j\leq p_i$的插入各自终点的平面直角坐标系维护凸包即可。转移的时候直接从起点的坐标系找。

代码不贴了，除了犯一些$\ast\ast$错误有手就行。

由于时间不回溯，所以没有后效性

