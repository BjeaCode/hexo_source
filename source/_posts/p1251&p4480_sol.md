---
title: P1251 & P4480 餐巾计划问题
date: 2021-12-31 14:12:49
tags:
  - 网络流
categories: 题解
author: Mr_Stranger_CW
mathjax: true
---

## 经典的网络 ~~瘤~~ 流题目

题意：一家餐厅，开$n$天，一开始没有餐巾。第$i$天要用$r_i$块**干净的**餐巾，然后他们会变成脏的。购买一块新的餐巾消耗$a$元，脏了的餐巾可以选择送去快洗，送去慢洗，或者存起来回头再洗，快洗用$t_1$天，花$c_1$元，慢洗用$t_2$天，花$c_2$元，保证$t1<t2$且$c1>c2$。

输入顺序：$n,r_{1-n},t1,c1,t2,c2$

问：这$n$天至少花多少钱。

**根据 ~~题目标签~~ 观察与思考 ~~以及$WA$了的假算~~ 还有尝试建模 我们发现这题 ~~显然~~ 竟然可以使用网络 ~~瘤~~ 流做。**
 
 #### 部分符号等表达：
 
**弧的表达：**$e(u,v,w,c)$表示一条以$u$为起点，$v$为终点，容量为$w$，单位流量花费为$c$的一条有向弧

$inf$，极大值

$S$：超级源点

$T$：超级汇点

网络流常用建模技巧之拆点

拆点，顾名思义，将题目中原本给定的一个点拆成两个或更多个。一般使用这种技巧的题目所使用的点都会对经过它的流进行操作。

以本题为例，我们以一天作为一个点，但是我们发现我们无法区分干净的餐巾或者脏了的餐巾。因为网络流在计算的时候只会流一种液体。

我们发现一个及其优良的性质，那就是将每一天拆成早上和晚上之后，晚上接收到的一定是脏了的餐巾，而早上接收的的餐巾一定是干净的。

所以我们尝试把每一天拆成早上和晚上。第$i$天的早上的点的编号是$i$，晚上的点的编号是$i+n$

先考虑搁置的脏餐巾。我们显然可以把它从一天晚上移动到第二天晚上，所以对于$\forall 1\leq i<n$，我们建立有向弧$e(i+n,i+1+n,inf,0)$表示这些餐巾搁置一晚。

然后考虑一下洗餐巾，这里只讨论快洗，因为慢洗同理。我们可以在第$i$天晚上花费$c_1$把一块餐巾送去快洗，然后在第$i+t_1$天早上把他拿回来用。所以我们可以建立有向弧$e(n+i,i+t_1,inf,c_1)$。

考虑买，我们直接把$S$到每一天早上之间建立有向弧$e(S,i,inf,a)$，表示购买餐巾。

我们发现方案满足当且仅当对于每一个$i$，第$i$天的早上都有至少$r_i$块餐巾。将每一天早上向$T$；连一条有向弧$e(i,T,r_i,0)$表示获取到的餐巾拿去用。

那么我们每天晚上获得到的脏餐巾从哪里来？从早上直接连边？这不行，因为这样的话你早上不仅要把餐巾流向晚上，你还要流向$T$。观察一下，我们发现因为每天都能够买，所以不会存在不合法的情况，所以每一天晚上获得的脏餐巾数量是固定的，那么我们直接从$S$连过取去有向弧$e(S,n+i,r_i,0)$表示晚上获取了餐巾即可。

这样的话，我们就已经建好一个合法的模型了。

因为最大流我们确定一定是$\sum\limits_{i=1}^nr_i$了，所以我们只需要在最大流条件下的最小费用就够了。

直接$SPFA$费用流跑就行，网络流一般不卡$SPFA$也很难卡$SPFA$，所以他诈尸了。

顺便讲一下$SPFA$费用流，他的本质就是以边费用为边权跑$SPFA$最短路，每次记录一个点最短路的前驱，然后从汇点向回追溯。

### $upd:2022.1.14$
因为一些离谱的原因，我去写了$P4480$，题面是一样的，但是数据范围比较。。。。离谱，可以认为是上面那个的加强版。

最终我靠着一些奇奇怪怪的小优化水了过去。

这道题中$n$的范围是$200000$，上面那题只有$2000$。

直接套用上面那题的代码改一下输入和数组大小之后你就可以获得$50$分的好成绩。现在来解决一下时间的问题。

因为上面是单路增广，一次只能找到一条增广路，效率十分的低下。

略加思考，我们发现这种单路增广的费用流和$EK$很像。

那么我们是否可以使用$Dinic$的思想去优化多路增广？

这是可以的。

在$Dinic$中，我们记录了一个点能够延伸出去的点，并在$DFS$的时候有方向的去找路，那么在多路增广$SPFA$费用流中我们可以通过最短路的更新来确定方向。

形式化的说，记$D_i$是$S$到$i$的最短路，如果对于一条有向弧$e(u,v,w,c)$，如果$D_u+c=D_v$，那么我们认为点$v$的最短路是从点$u$延伸来的。

这样我们的更新就有了方向。

这样的话我们就能拿到$70$分了。

剩下的话还需要继续优化。

相信各位都知道当前弧优化吧？

（会的这段自动跳过）当前弧优化是指，如果说我们在之前经通过这条弧尝试增广了。那么在第二次及以后到达这个点的时候就不用再去遍历这条弧了。因为上一次我们已经“榨干”他的剩余价值了（大雾

加上当前弧优化之后我们就能拿到$90$分了。

剩下的$10$分如何获得？

我们发现再对费用流算法优化已经比较困难了，所以我们尝试优化$SPFA$那部分。

这里介绍两种优化：$SLF$和$LLL$优化。

原先的$SPFA$算法中，我们每次更新一个点的最短路的时候都会把它插入到队列的尾部。

但是插入到尾部不一定比插入到头部更优。

我们知道，一般来说，最短路更小的点更容易更新其他点。

$SLF$优化就是将原先的队列更换成双端队列。在插入的时候与队首作比较，如果比队首要小，那么就插入到队首，否则插入到队尾。

而$LLL$优化就是记录一下当前队列中最短路的平均值，
每次取出一个点之后，如果发现这个店的最短路大于这个平均值就是扔到队尾换下一个去松弛。

两个是可以同时使用的。

当然，就算有了这两个优化，$SPFA$该被卡还是会被卡，而且一般来说这两个优化其实并不是特别大。

不过对这道题已经足够了，加上$SLF$优化之后就可以通过了。~~虽然最后一个点还是在$T$掉的边缘徘徊~~